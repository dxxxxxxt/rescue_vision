# 救援机器人视觉系统技术方案

## 1. 项目概述

### 1.1 项目背景
本项目是为救援机器人比赛开发的视觉系统，负责实时检测、识别和跟踪比赛场地中的各种颜色小球，并根据比赛规则选择最优的转运目标，为机器人的运动和抓取决策提供依据。

### 1.2 比赛规则核心要求
- **第一次转运**：必须是我方普通球，否则成绩无效
- **数量限制**：一次转移普通球+核心球不能超过4个
- **危险球限制**：黄色危险球必须单独转运，否则比赛结束
- **禁止操作**：不能夹取对方球，否则成绩无效
- **得分规则**：自主模式得分是遥控模式的4倍，建议优先使用自主模式
- **颜色识别**：必须准确识别红、蓝、黑、黄四种颜色小球

## 2. 技术架构

### 2.1 系统架构

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  摄像头模块    │────▶│  颜色检测模块   │────▶│  小球跟踪模块   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
          ▲                        ▲                        ▲
          │                        │                        │
          └────────────────────────┼────────────────────────┘
                                   │
                                   ▼
                            ┌─────────────────┐
                            │  视觉核心模块   │
                            └─────────────────┘
                                   │
                                   ▼
                            ┌─────────────────┐
                            │  策略决策模块   │
                            └─────────────────┘
                                   │
                                   ▼
                            ┌─────────────────┐
                            │  输出接口模块   │
                            └─────────────────┘
```

### 2.2 核心模块说明

| 模块名称       | 主要功能                  | 实现类/文件                  |
|----------------|---------------------------|------------------------------|
| 颜色检测模块   | 基于HSV阈值检测小球颜色   | ColorDetector (<mcfile name="color_detector.py" path="d:/Rescue_Rebot/rescue_vision/src/color_detector.py"></mcfile>) |
| 小球跟踪模块   | 检测和跟踪小球轮廓        | BallTracker (<mcfile name="ball_tracker.py" path="d:/Rescue_Rebot/rescue_vision/src/ball_tracker.py"></mcfile>) |
| 视觉核心模块   | 协调各模块工作            | VisionCore (<mcfile name="vision_core.py" path="d:/Rescue_Rebot/rescue_vision/src/vision_core.py"></mcfile>) |
| 策略决策模块   | 根据规则选择最佳目标      | VisionCore中的策略方法       |
| 输出接口模块   | 提供检测结果和目标信息    | VisionCore中的get_best_target等方法 |

## 3. 核心功能实现

### 3.1 颜色检测

#### 3.1.1 算法原理
采用HSV颜色空间进行颜色检测，通过配置文件定义各颜色的HSV阈值范围，支持多范围颜色（如红色的两个范围）的检测。

#### 3.1.2 实现细节
```python
def detect_color(self, image, color_name):
    # 图像预处理（高斯模糊）
    processed = self.preprocess_image(image)
    
    # 转换为HSV颜色空间
    hsv = cv2.cvtColor(processed, cv2.COLOR_BGR2HSV)
    
    # 获取颜色的HSV阈值
    color_config = self.hsv_thresholds[color_name]
    
    # 创建掩码（支持多范围颜色）
    masks = []
    for range_config in color_config:
        lower = np.array(range_config['lower'], dtype=np.uint8)
        upper = np.array(range_config['upper'], dtype=np.uint8)
        mask = cv2.inRange(hsv, lower, upper)
        masks.append(mask)
    
    # 合并所有掩码
    combined_mask = np.bitwise_or.reduce(masks) if len(masks) > 1 else masks[0]
    
    # 形态学操作：开运算去噪，闭运算填充孔洞
    kernel = np.ones((5, 5), np.uint8)
    mask = cv2.morphologyEx(combined_mask, cv2.MORPH_OPEN, kernel)
    mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel)
    
    return mask
```

### 3.2 小球跟踪

#### 3.2.1 算法原理
使用OpenCV的轮廓检测功能识别小球轮廓，根据面积和圆形度筛选有效目标，并使用跟踪窗口优化跟踪效果。

#### 3.2.2 半径参数配置
通过配置文件中的`min_ball_radius`和`max_ball_radius`参数控制检测的小球大小范围，当前配置为8-30像素（对应实际15-55mm）。

### 3.3 游戏策略实现

#### 3.3.1 优先级计算
```python
def calculate_ball_priority(self, ball):
    color = ball['color']
    
    # 不能夹取对方小球
    if color == self.enemy_color:
        return 0  # 对方球优先级为0
    
    # 第一个必须是己方球
    if self.first_pick:
        return 1000 if color == self.team_color else 0
    
    # 正常优先级计算（从配置文件读取）
    if color == self.team_color:
        return self.ball_priorities.get('team', 100)
    else:
        return self.ball_priorities.get(color, 0)
```

#### 3.3.2 关键规则实现
- **第一次转运规则**：通过`first_pick`标志位控制，完成后调用`set_first_pick_done()`方法
- **危险球单独转运**：在`get_best_target()`中自动实现，每次只夹取一个球
- **数量限制检查**：通过`check_transfer_limit()`方法检查，普通球+核心球不能超过4个

### 3.4 目标选择

```python
def get_best_target(self, balls, current_balls=[]):
    if not balls:
        return None
    
    prioritized_balls = self.get_prioritized_balls(balls)
    
    # 由于每次只夹取一个，直接返回最高优先级球
    return prioritized_balls[0] if prioritized_balls[0]['priority'] > 0 else None
```

## 4. 配置文件说明

### 4.1 HSV阈值配置（hsv_thresholds.json）
```json
{
  "red": [
    {"lower": [0, 100, 100], "upper": [10, 255, 255]},
    {"lower": [160, 100, 100], "upper": [180, 255, 255]}
  ],
  "yellow": [{"lower": [20, 100, 100], "upper": [30, 255, 255]}],
  "blue": [{"lower": [100, 100, 100], "upper": [130, 255, 255]}],
  "black": [{"lower": [0, 0, 0], "upper": [180, 255, 50]}]
}
```

### 4.2 策略配置（game_strategy.json）
```json
{
  "team_color": "red",
  "ball_priorities": {
    "black": 200,  // 核心球优先级最高
    "yellow": 150, // 危险球其次
    "team": 100,   // 己方普通球
    "enemy": 0     // 对方球不考虑
  },
  "vision_params": {
    "camera_id": 0,
    "image_width": 640,
    "image_height": 480,
    "min_ball_radius": 8,
    "max_ball_radius": 30
  }
}
```

## 5. 测试方案

### 5.1 单元测试
- **颜色检测测试**：测试所有基础颜色（red, yellow, blue, black）的检测准确性
- **策略逻辑测试**：测试优先级计算、第一次转运规则、危险球限制等
- **边界情况测试**：测试小尺寸小球、部分遮挡小球等情况

### 5.2 集成测试
- **完整流程测试**：从图像采集到目标输出的完整流程测试
- **真实场景测试**：在模拟比赛场地进行实际测试

### 5.3 测试文件
- <mcfile name="test_color_detector.py" path="d:/Rescue_Rebot/rescue_vision/texts/test_color_detector.py"></mcfile>：颜色检测单元测试
- <mcfile name="test_advanced_color_detection.py" path="d:/Rescue_Rebot/rescue_vision/texts/test_advanced_color_detection.py"></mcfile>：高级颜色检测测试
- <mcfile name="test_edge_cases.py" path="d:/Rescue_Rebot/rescue_vision/texts/test_edge_cases.py"></mcfile>：边界情况测试

## 6. 运行与部署

### 6.1 运行命令
```bash
# 直接运行主程序
python src/main.py

# 运行单元测试
python -m unittest texts/test_color_detector.py
```

### 6.2 部署环境
- Python 3.6+
- OpenCV 4.0+
- NumPy 1.18+

## 7. 优化方向

### 7.1 性能优化
- **并行处理**：使用多线程或GPU加速颜色检测
- **ROI检测**：只在感兴趣区域进行检测，减少计算量

### 7.2 算法优化
- **颜色自适应**：根据光线变化自动调整HSV阈值
- **小球预测**：使用卡尔曼滤波预测小球运动轨迹
- **多摄像头融合**：支持多摄像头数据融合，提高检测范围

### 7.3 功能扩展
- **安全区识别**：增加安全区检测功能，避免误入对方区域
- **多目标跟踪**：支持同时跟踪多个目标，提高转运效率
- **故障恢复**：增加系统故障检测和自动恢复机制

## 8. 风险分析与应急预案

| 风险场景               | 风险等级 | 应对措施                                      |
|------------------------|----------|-----------------------------------------------|
| 第一次转运失败         | 极高     | 冗余识别算法，确保准确识别己方颜色            |
| 危险球误操作           | 极高     | 严格的黄色球检测和单独转运逻辑                |
| 光线突变影响识别       | 高       | 多套HSV参数，根据光线条件自动切换            |
| 摄像头故障             | 高       | 备用摄像头切换机制                            |
| 程序崩溃               | 中       | 看门狗机制和自动重启功能                      |

## 9. 结论

本技术方案基于比赛规则和现有代码，实现了一个功能完整、规则严格、性能可靠的救援机器人视觉系统。系统采用模块化设计，便于维护和扩展，能够满足比赛的各项要求。通过完善的测试方案和优化方向，确保系统在实际比赛中能够稳定运行并取得良好成绩。