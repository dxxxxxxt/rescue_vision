# 智能救援小车视觉系统

这是一个为智能救援小车比赛设计的视觉系统，用于检测和识别红、黄、蓝、黑四种颜色的小球，并根据比赛规则进行目标优先级排序。

## 功能特性

- **多颜色检测**：支持红、黄、蓝、黑四种颜色的小球检测
- **目标跟踪**：实时跟踪检测到的小球位置
- **优先级排序**：根据比赛规则对小球进行优先级排序
  - 黑色小球（核心救援目标）优先级最高
  - 黄色小球（特殊规则）优先级次之
  - 己方颜色小球优先级中等
  - 敌方颜色小球优先级最低
- **首球规则**：严格遵守比赛要求，第一个夹取的小球必须是己方颜色的小球
- **可视化界面**：实时显示检测结果和最佳目标标记
- **配置灵活**：支持通过JSON配置文件调整颜色阈值和游戏策略

## 项目结构

```
rescue_vision/
├── config/                   # 配置文件目录
│   ├── hsv_thresholds.json     # HSV颜色阈值配置
│   ├── game_strategy.json      # 游戏策略配置
│   └── exposure_presets.json   # 摄像头曝光预设配置
├── src/                      # 源代码目录
│   ├── color_detector.py       # 颜色检测模块
│   ├── ball_tracker.py         # 小球跟踪模块
│   ├── vision_core.py          # 视觉核心模块
│   ├── vision_serial.py        # 串口通信模块
│   ├── main.py                 # 主程序入口
│   ├── utils/                  # 工具模块目录
│   └── logs/                   # 日志目录
├── docs/                     # 文档目录
│   ├── 开发日志.md              # 开发日志
│   ├── 比赛规则分析.md          # 规则解读
│   └── 技术方案.md              # 技术设计文档  
├── texts/                    # 测试脚本目录
│   ├── serial_debugger.py         # 串口调试工具
│   ├── test_color_detector.py     # 颜色检测测试
│   ├── test_advanced_color_detection.py  # 高级颜色检测测试
│   ├── test_edge_cases.py         # 边缘情况测试
│   └── test_yuzhi.py              # 阈值调整工具
└── README.md                 # 项目说明文档
```



## 配置说明

### HSV颜色阈值配置 (hsv_thresholds.json)

该文件定义了四种颜色的HSV阈值范围，用于颜色检测：

```json
{
  "red": [
    {"lower": [0, 100, 100], "upper": [10, 255, 255]},
    {"lower": [160, 100, 100], "upper": [180, 255, 255]}
  ],
  "yellow": [
    {"lower": [20, 100, 100], "upper": [30, 255, 255]}
  ],
  "blue": [
    {"lower": [100, 100, 100], "upper": [130, 255, 255]}
  ],
  "black": [
    {"lower": [0, 0, 0], "upper": [180, 255, 50]}
  ]
}
```

### 游戏策略配置 (game_strategy.json)

该文件定义了队伍颜色、小球优先级和视觉参数：

```json
{
  "team_color": "red",      // 己方颜色（red或blue）
  "ball_priorities": {      // 小球优先级（值越高优先级越高）
    "black": 200,
    "yellow": 150,
    "team": 100,
    "enemy": 0
  },
  "yellow_rules": {
    "max_count": 2,         // 黄色小球数量
    "cannot_hold_other": true  // 夹取黄色小球时不能同时夹其他小球
  },
  "ball_counts": {
    "red": 4,              // 红色小球数量
    "blue": 4,             // 蓝色小球数量
    "black": 4,            // 黑色小球数量
    "yellow": 2            // 黄色小球数量
  },
  "vision_params": {
    "camera_id": 0,         // 摄像头ID
    "image_width": 640,     // 图像宽度
    "image_height": 480,    // 图像高度
    "detection_confidence": 0.8,  // 检测置信度
    "tracking_window": 50   // 跟踪窗口大小
  }
}
```

## 使用方法

### 运行视觉系统

```bash
cd rescue_vision/src
python main.py
```

### 调整配置

1. **调整颜色阈值**：修改`config/hsv_thresholds.json`文件中的HSV值
2. **更改队伍颜色**：修改`config/game_strategy.json`中的`team_color`字段
3. **调整优先级**：修改`config/game_strategy.json`中的`ball_priorities`字段

## 模块说明

### color_detector.py

颜色检测模块，负责将输入图像转换为HSV颜色空间，并根据配置的阈值检测特定颜色区域。

### ball_tracker.py

小球跟踪模块，负责从颜色掩码中识别圆形物体，并计算小球的位置和大小。

### vision_core.py

视觉核心模块，整合颜色检测和小球跟踪功能，实现目标优先级排序和最佳目标选择。

### vision_serial.py

串口通信模块，负责与电控系统进行数据交互，发送控制命令和接收反馈信息。

### main.py

主程序入口，负责初始化视觉系统并启动运行，协调各模块工作。

### serial_debugger.py

串口调试工具，用于测试和调试串口通信功能，支持各种命令发送和数据接收测试。

## 比赛规则支持

- **队伍识别**：通过配置`team_color`参数支持红/蓝两队，系统会自动识别己方和敌方小球
- **首球强制规则**：系统会自动确保第一个目标选择的是己方颜色小球，防止因误操作导致淘汰
- **小球数量**：支持比赛指定的小球数量配置（红色4个、蓝色4个、黑色4个、黄色2个）
- **危险球单独转运**：黄色球（危险球）必须单独转运，不能与其他小球同时夹取
- **数量限制**：一次转移不能超过4个普通球（红/蓝）+ 核心球（黑）
- **优先级策略**：根据比赛得分规则优化优先级，核心球（黑）优先级最高，其次是危险球（黄）
- **得分计算**：支持自主模式和遥控模式的得分计算，帮助优化策略

但其实我们队伍每次只夹取一个小球，应该不会出现夹取超过四个小球的情况

## 开发日志

请参考`开发日志.md`文件了解项目的开发过程和更新记录。

## 注意事项

1. 首次使用前请确保摄像头已正确连接
2. 根据实际环境调整HSV颜色阈值以获得最佳检测效果
3. 比赛前请确认队伍颜色配置正确
4. 视觉系统运行时，按下'q'键可退出程序
5. 使用串口调试工具前，请确保已安装pyserial库：`pip install pyserial`
